## creating FCOS image for fast-vm
At this point image is a converted QEMU qcow2.xz image with basic Ignition file.

1. Get the QEMU qcow2.xz image and unpack it (~2GB space is needed)
  ~~~
  # wget https://builds.coreos.fedoraproject.org/prod/streams/stable/builds/32.20200601.3.0/x86_64/fedora-coreos-32.20200601.3.0-qemu.x86_64.qcow2.xz
  # unxz fedora-coreos-32.20200601.3.0-qemu.x86_64.qcow2.xz
  ~~~

2. Create empty fast-vm image of size 8GB (to match the size of qcow2 image)
  ~~~
  # qemu-img info fedora-coreos-32.20200601.3.0-qemu.x86_64.qcow2 |grep 'virtual size'
  virtual size: 8.0G (8589934592 bytes)
  # fast-vm-image import_custom 8 fcos32.200601 empty ../xml/fcos-32.xml
  ...
  [__][inf] importing image empty into /dev/xxx/fastvm-fcos32.200601
  ...
  ~~~

3. Convert image from QCOW2 to RAW and store it in empty fast-vm image device. NOTE: image will allocate 100% of image size and next steps will remove empty space from there.
  ~~~
  # qemu-img convert -p -O raw fedora-coreos-32.20200601.3.0-qemu.x86_64.qcow2 /dev/xxx/fastvm-fcos32.200601
  # fast-vm-image list
  IMAGE                                |SYSTEM                |USER                  |
  Image name             Size( %used ) |XML      Hack file for|XML      Hack file for|
  ...
  fcos32.200601            8g(100.00%) |missing  no hack files|ok       no hack files|
  ...

  ~~~

4. Modify the image to include the basic Ignition file from this repository
  ~~~
  # LIBGUESTFS_BACKEND=direct guestfish -a /dev/xxx/fastvm-fcos32.200601 -m /dev/sda1 << EOF
  mkdir /ignition
  copy-in fcos-32/config.ign /ignition
  EOF
  ~~~

5. (1/2) sparsify image: use `fast-vm-miage compact` to cleanup free space on filesystems.
  ~~~
  # fast-vm-image compact fcos32.200601
  ~~~

6. (2/2) sparsify image: tell thinpool to remove all space after last partition. First determine where last partition ends and then tell `blkdiscard` to remove everything after that location. NOTE: this will also remove backup GPT table from disk which will get automatically regenerated by Ignition when automatically resizing the partitions.
  ~~~
  # fdisk -l /dev/xxx/fastvm-fcos32.200601
  ...
  Units: sectors of 1 * 512 = 512 bytes
  ...
  Device                            Start     End Sectors  Size Type
  ...
  /dev/xxx/fastvm-fcos32.200601p4 1050624 5636095 4585472  2.2G Linux filesystem
  ...
  # echo "(5636095+1)*512"|bc
  2885681152
  ~~~

  ~~~
  # blkdiscard -o 2885681152/dev/xxx/fastvm-fcos32.200601
  # fast-vm-image list|grep fcos32.200601
  fcos32.200601            8g( 22.27%) |missing  no hack files|ok       no hack files|
  ~~~

7. Export image and generate checksums for it.
  ~~~
  # fast-vm-image export fcos32.200601 zst
  # fast-vm-image export fcos32.200601 xz
  # fast-vm-image gen_checksums fcos32.200601 
  ~~~
