## creating config.ign for RHCOS
As of version 4.4.3 the RHCOS is using ignition file version 2.2.0 which looks like should be created by hand. There is `fcct` tool from Fedora that can "generate" ignition 3.0.0 files that are "not that much different" from version 2.2.0. Anyway the ignotion file provided here is rather simple one so some changes were done by hand.

- [Ignition 2.2.0 syntax examples](https://coreos.com/ignition/docs/latest/examples.html)
- [Ignition 2.2.x spec](https://github.com/coreos/ignition/tree/spec2x)

## creating FCOS image for fast-vm
At this point image is a converted QEMU qcow2.xz image with basic Ignition file.

1. Get the QEMU qcow2.gz image and unpack it (~2.5GB space is needed) - [RHCOS downloads](https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/)
  ~~~
  # wget https://mirror.openshift.com/pub/openshift-v4/dependencies/rhcos/4.4/4.4.3/rhcos-4.4.3-x86_64-qemu.x86_64.qcow2.gz
  # gunzip rhcos-4.4.3-x86_64-qemu.x86_64.qcow2.gz
  ~~~

2. Create empty fast-vm image of size 16GB (to match the size of qcow2 image)
  ~~~
  # qemu-img info rhcos-4.4.3-x86_64-qemu.x86_64.qcow2 |grep 'virtual size'
  virtual size: 16G (17179869184 bytes)
  # fast-vm-image import_custom 16 rhcos-4.4.3 empty ../xml/rhcos-4.4.xml
  ...
  [__][inf] importing image empty into /dev/xxx/fastvm-rhcos-4.4.3
  ...
  ~~~

3. Convert image from QCOW2 to RAW and store it in empty fast-vm image device. NOTE: image will allocate 100% of image size and next steps will remove empty space from there.
  ~~~
  # qemu-img convert -p -O raw rhcos-4.4.3-x86_64-qemu.x86_64.qcow2 /dev/vg_raid1/fastvm-rhcos-4.4.3
  # fast-vm-image list
  IMAGE                                |SYSTEM                |USER                  |
  Image name             Size( %used ) |XML      Hack file for|XML      Hack file for|
  ...
  rhcos-4.4.3             16g(100.00%) |missing  no hack files|ok       no hack files|
  ...

  ~~~

4. Modify the image to include the basic Ignition file from this repository
  ~~~
  # LIBGUESTFS_BACKEND=direct guestfish -a /dev/xxx/fastvm-rhcos-4.4.3 -m /dev/sda1 << EOF
  mkdir /ignition
  copy-in rhcos-4.4.3/config.ign /ignition
  EOF
  ~~~

5. (1/2) sparsify image: use `fast-vm-image compact` to cleanup free space on filesystems. 
NOTE1: during compact you will be asked for password of `/dev/sda4`. You can ignore this and provide anything as this space will not be compacted.
NOTE2: There is RFE to add support for LUKS into virt-sparsify - [Bug 1791353 - RFE: virt-sparsify should support sparsifying LUKS-encrypted guests ](https://bugzilla.redhat.com/show_bug.cgi?id=1791353)
  ~~~
  # fast-vm-image compact rhcos-4.4.3
  ~~~

6. (2/2) sparsify image: tell thinpool to remove all space after last partition. First determine where last partition ends and then tell `blkdiscard` to remove everything after that location. NOTE: this will also remove backup GPT table from disk which will get automatically regenerated by Ignition when automatically resizing the partitions.
  ~~~
  # fdisk -l /dev/xxx/fastvm-rhcos-4.4.3
  ...
  Units: sectors of 1 * 512 = 512 bytes
  ...
  Device                          Start     End Sectors  Size Type
  ...
  /dev/xxx/fastvm-rhcos-4.4.3p4 1050624 7020543 5969920  2.9G Linux filesystem
  ...
  # echo "(7020543+1)*512"|bc
  3594518528
  ~~~

  ~~~
  # blkdiscard -o 3594518528 /dev/xxx/fastvm-rhcos-4.4.3
  # fast-vm-image list|grep rhcos-4.4.3
  rhcos-4.4.3             16g( 18.50%) |missing  no hack files|ok       no hack files|
  ~~~

7. Export image and generate checksums for it.
  ~~~
  # fast-vm-image export rhcos-4.4.3 zst
  # fast-vm-image export rhcos-4.4.3 xz
  # fast-vm-image gen_checksums rhcos-4.4.3
  ~~~
